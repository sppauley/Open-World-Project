[
    {
        "name": "Phantom AI",
        "trigger": "turn_change",
        "level_nid": "4",
        "condition": "game.check_alive('Phantom') and game.turncount>2",
        "commands": [],
        "only_once": false,
        "priority": 19,
        "_source": [
            "# gets available tiles NEAR player/other units",
            "# checks to see if they're in range",
            "# moves the phantom",
            "",
            "# retreats if HP less than a third",
            "if;u('Phantom').get_hp() < 20",
            "flicker_cursor;Phantom",
            "wait;300",
            "map_anim;Warp;Phantom;no_block",
            "move_unit;Phantom;20,9;immediate;closest;no_block",
            "flicker_cursor;Phantom",
            "wait;500",
            "finish",
            "",
            "# else targets normally",
            "else",
            "for;PLAYER_UNIT;static_random.shuffle([unit.nid for unit in game.get_player_units()])",
            "    add_region;PhantomSpawn;{eval:u('{PLAYER_UNIT}').position[0] + 4,u('{PLAYER_UNIT}').position[1]+4};7,7;normal",
            "    for;PLAYER_POS;static_random.shuffle([game.get_region('PhantomSpawn').get_all_positions()[i] for i in [0,1,2,4,5,6,7,8,12,13,14,20,28,34,35,36,40,41,42,43,44,46,47,48]])",
            "        if;DB.terrain.get(game.tilemap.get_terrain({PLAYER_POS})).name in ['Floor','Stairs','Carpet'] and not game.board.in_vision({PLAYER_POS},'player')",
            "            flicker_cursor;Phantom",
            "            wait;300",
            "            map_anim;Warp;Phantom;no_block",
            "            move_unit;Phantom;{PLAYER_POS};immediate;closest;no_block",
            "            wait;500",
            "            remove_region;PhantomSpawn",
            "            finish",
            "        end",
            "    endf",
            "    remove_region;PhantomSpawn",
            "endf",
            "end"
        ]
    }
]